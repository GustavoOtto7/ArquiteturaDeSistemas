### ğŸ“‹ Testes da Arquitetura Orientada a Eventos

## âœ… Teste 1: Criar Pedido (Dispara order.created)

```http
POST http://localhost:3003/v1/orders
Content-Type: application/json

{
  "clientId": "507f1f77bcf86cd799439012",
  "items": [
    {
      "productId": "507f1f77bcf86cd799439013",
      "quantity": 2
    }
  ]
}
```

**Resposta Esperada (201 Created):**
```json
{
  "_id": "507f1f77bcf86cd799439014",
  "clientId": "507f1f77bcf86cd799439012",
  "status": "AGUARDANDO PAGAMENTO",
  "total": 299.99,
  "items": [
    {
      "productId": "507f1f77bcf86cd799439013",
      "productName": "Produto X",
      "quantity": 2,
      "unitPrice": 149.99,
      "subtotal": 299.98
    }
  ],
  "isDeleted": false,
  "createdAt": "2025-11-15T10:30:00.000Z",
  "updatedAt": "2025-11-15T10:30:00.000Z"
}
```

**Evento Publicado no RabbitMQ:**
```javascript
{
  type: "order.created",
  timestamp: "2025-11-15T10:30:00.000Z",
  data: {
    orderId: "507f1f77bcf86cd799439014",
    clientId: "507f1f77bcf86cd799439012",
    total: 299.99,
    status: "AGUARDANDO PAGAMENTO",
    itemsCount: 1,
    createdAt: "2025-11-15T10:30:00.000Z"
  }
}
```

**Logs Esperados no Notification Service:**
```
ğŸ”„ Roteando evento: order.created

ğŸ“¦ ========== EVENTO: Pedido Criado ==========
   ğŸ†” Pedido ID: 507f1f77bcf86cd799439014
   ğŸ‘¤ Cliente ID: 507f1f77bcf86cd799439012
   ğŸ’° Valor Total: R$ 299.99
   ğŸ“¦ Quantidade de Itens: 1
   â° Timestamp: 2025-11-15T10:30:00.000Z

ğŸ“¤ Enviando notificaÃ§Ã£o Push:
   TÃ­tulo: âœ… Pedido Criado com Sucesso!
   Mensagem: Seu pedido #507f1f77bcf86cd799439014 foi criado. Aguardando pagamento de R$ 299.99

âœ… NotificaÃ§Ã£o enviada para cliente 507f1f77bcf86cd799439012
==========================================
```

---

## âœ… Teste 2: Atualizar Status para PAGO (Dispara order.paid)

```http
PATCH http://localhost:3003/v1/orders/507f1f77bcf86cd799439014
Content-Type: application/json

{
  "status": "PAGO"
}
```

**Resposta Esperada (200 OK):**
```json
{
  "_id": "507f1f77bcf86cd799439014",
  "clientId": "507f1f77bcf86cd799439012",
  "status": "PAGO",
  "total": 299.99,
  "items": [
    {
      "productId": "507f1f77bcf86cd799439013",
      "productName": "Produto X",
      "quantity": 2,
      "unitPrice": 149.99,
      "subtotal": 299.98
    }
  ],
  "isDeleted": false,
  "createdAt": "2025-11-15T10:30:00.000Z",
  "updatedAt": "2025-11-15T10:35:00.000Z"
}
```

**Evento Publicado no RabbitMQ:**
```javascript
{
  type: "order.paid",
  timestamp: "2025-11-15T10:35:00.000Z",
  data: {
    orderId: "507f1f77bcf86cd799439014",
    clientId: "507f1f77bcf86cd799439012",
    status: "PAGO",
    total: 299.99,
    updatedAt: "2025-11-15T10:35:00.000Z"
  }
}
```

**Logs Esperados no Notification Service:**
```
ğŸ”„ Roteando evento: order.paid

ğŸ’³ ========== EVENTO: Pedido Pago com Sucesso ==========
   ğŸ†” Pedido ID: 507f1f77bcf86cd799439014
   ğŸ‘¤ Cliente ID: 507f1f77bcf86cd799439012
   ğŸ’° Valor Pago: R$ 299.99
   âœ… Status: PAGO
   â° Timestamp: 2025-11-15T10:35:00.000Z

ğŸ“¤ Enviando notificaÃ§Ã£o Push:
   TÃ­tulo: ğŸ’³ Pagamento Confirmado!
   Mensagem: Pagamento de R$ 299.99 confirmado para pedido #507f1f77bcf86cd799439014. Seu pedido estÃ¡ sendo preparado!

âœ… NotificaÃ§Ã£o enviada para cliente 507f1f77bcf86cd799439012
======================================================
```

---

## âœ… Teste 3: Atualizar Status para FALHA NO PAGAMENTO (Dispara order.failed)

```http
PATCH http://localhost:3003/v1/orders/507f1f77bcf86cd799439014
Content-Type: application/json

{
  "status": "FALHA NO PAGAMENTO"
}
```

**Resposta Esperada (200 OK):**
```json
{
  "_id": "507f1f77bcf86cd799439014",
  "clientId": "507f1f77bcf86cd799439012",
  "status": "FALHA NO PAGAMENTO",
  "total": 299.99,
  "items": [...]
}
```

**Evento Publicado no RabbitMQ:**
```javascript
{
  type: "order.failed",
  timestamp: "2025-11-15T10:40:00.000Z",
  data: {
    orderId: "507f1f77bcf86cd799439014",
    clientId: "507f1f77bcf86cd799439012",
    status: "FALHA NO PAGAMENTO",
    total: 299.99,
    updatedAt: "2025-11-15T10:40:00.000Z"
  }
}
```

**Logs Esperados no Notification Service:**
```
ğŸ”„ Roteando evento: order.failed

âŒ ========== EVENTO: Falha no Pagamento ==========
   ğŸ†” Pedido ID: 507f1f77bcf86cd799439014
   ğŸ‘¤ Cliente ID: 507f1f77bcf86cd799439012
   ğŸ’° Valor Tentado: R$ 299.99
   âŒ Status: FALHA NO PAGAMENTO
   â° Timestamp: 2025-11-15T10:40:00.000Z

ğŸ“¤ Enviando notificaÃ§Ã£o Push de ALERTA:
   TÃ­tulo: âŒ Falha no Pagamento
   Mensagem: NÃ£o conseguimos processar o pagamento de R$ 299.99 para pedido #507f1f77bcf86cd799439014. Tente novamente com outro mÃ©todo de pagamento.

âœ… NotificaÃ§Ã£o enviada para cliente 507f1f77bcf86cd799439012
================================================
```

---

## âœ… Teste 4: NotificaÃ§Ã£o Direta (Sem RabbitMQ)

```http
POST http://localhost:3005/v1/notifications
Content-Type: application/json

{
  "clientId": "507f1f77bcf86cd799439012",
  "title": "ğŸ‰ Teste Manual",
  "message": "Esta Ã© uma notificaÃ§Ã£o enviada diretamente"
}
```

**Resposta Esperada (200 OK):**
```json
{
  "success": true,
  "message": "NotificaÃ§Ã£o enviada (simulada)",
  "notification": {
    "clientId": "507f1f77bcf86cd799439012",
    "title": "ğŸ‰ Teste Manual",
    "message": "Esta Ã© uma notificaÃ§Ã£o enviada diretamente"
  }
}
```

**Logs Esperados no Notification Service:**
```
ğŸ“¤ [PUSH DIRETO] NotificaÃ§Ã£o para cliente 507f1f77bcf86cd799439012:
   TÃ­tulo: ğŸ‰ Teste Manual
   Mensagem: Esta Ã© uma notificaÃ§Ã£o enviada diretamente
```

---

## âœ… Teste 5: Health Check

```http
GET http://localhost:3003/health
```

**Orders Service (200 OK):**
```json
{
  "service": "orders-service",
  "status": "ok",
  "uptime": 125.456,
  "database": "MongoDB",
  "rabbitMQ": "connected"
}
```

```http
GET http://localhost:3005/health
```

**Notification Service (200 OK):**
```json
{
  "service": "notification-service",
  "status": "ok",
  "uptime": 120.123,
  "rabbitmq": "connected"
}
```

---

## ğŸ” ValidaÃ§Ã£o da LÃ³gica

### âœ… Orders Service (Publisher)

**Checklist:**
- [x] Conecta ao RabbitMQ ao iniciar
- [x] Publica `order.created` quando pedido Ã© criado
- [x] Publica `order.paid` quando status muda para PAGO
- [x] Publica `order.failed` quando status muda para FALHA NO PAGAMENTO
- [x] Trata erros sem parar o fluxo principal
- [x] Incluem timestamps nos eventos
- [x] Incluem dados necessÃ¡rios no evento

### âœ… Notification Service (Consumer)

**Checklist:**
- [x] Conecta ao RabbitMQ ao iniciar
- [x] Se subscreve aos 4 tipos de eventos
- [x] Processa cada evento corretamente
- [x] Dispara handler apropriado para cada tipo
- [x] Reconhece (ACK) mensagens apÃ³s processar
- [x] Reenvia (NACK) em caso de erro
- [x] Inclui comentÃ¡rios explicativos
- [x] Usa emojis para melhor visualizaÃ§Ã£o
- [x] Suporta notificaÃ§Ãµes diretas via HTTP

### âœ… RabbitMQ Broker

**Checklist:**
- [x] Exchange `ecommerce_events` Ã© do tipo `topic`
- [x] Mensagens sÃ£o persistentes
- [x] Filas sÃ£o durÃ¡veis
- [x] Suporta mÃºltiplos consumers
- [x] Roteia mensagens corretamente

---

## ğŸ“Š Fluxo Completo de Eventos

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CLIENTE FAZ REQUISIÃ‡ÃƒO: POST /v1/orders                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ORDERS SERVICE - create()        â”‚
        â”‚ âœ“ Valida cliente                 â”‚
        â”‚ âœ“ Valida produtos/estoque        â”‚
        â”‚ âœ“ Cria pedido no MongoDB         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜
                 â”‚                       â”‚
                 â”‚ Salvo com sucesso     â”‚ Publicar Evento
                 â–¼                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Resposta ao      â”‚    â”‚ RABBITMQ PUBLISH    â”‚
        â”‚ Cliente          â”‚    â”‚                     â”‚
        â”‚ 201 Created      â”‚    â”‚ order.created       â”‚
        â”‚ {pedido}         â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
                                           â–¼
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚ RABBITMQ BROKER    â”‚
                                  â”‚ Exchange: topic    â”‚
                                  â”‚ Rota: order.createdâ”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ (pode ter      â”‚               â”‚
                            â”‚ mÃºltiplos)     â”‚               â”‚
                            â–¼               â–¼               â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ NOTIFICATION SERVICE - Consumers             â”‚
                  â”‚                                              â”‚
                  â”‚ âœ“ Consome evento order.created              â”‚
                  â”‚ âœ“ Chama dispatchNotification(event)         â”‚
                  â”‚ âœ“ Identifica tipo: order.created            â”‚
                  â”‚ âœ“ Executa handleOrderCreated(event)         â”‚
                  â”‚ âœ“ Envia notificaÃ§Ã£o Push ao cliente         â”‚
                  â”‚ âœ“ ACK - Reconhece processamento             â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚ Cliente recebe   â”‚
                     â”‚ notificaÃ§Ã£o:     â”‚
                     â”‚                  â”‚
                     â”‚ âœ… Pedido Criado â”‚
                     â”‚    com Sucesso   â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš¨ Tratamento de Erros

### Erro: RabbitMQ nÃ£o conectado

**Orders Service:**
```
âš  RabbitMQ nÃ£o conectado, tentando reconectar...
âœ— Erro ao publicar evento order.created: ...
```
**AÃ§Ã£o:** Continua funcionar sem eventos (fallback)

**Notification Service:**
```
âœ— Erro ao conectar ao RabbitMQ: ...
âš ï¸  Tentando reconectar em 5 segundos...
```
**AÃ§Ã£o:** Tenta reconectar indefinidamente

### Erro: Falha ao processar evento

```
âŒ Erro ao processar evento order.created: ...
âš ï¸  Mensagem reenviada para fila (NACK)
```
**AÃ§Ã£o:** Mensagem volta Ã  fila e Ã© reprocessada

---

## ğŸ“š ReferÃªncias de ImplementaÃ§Ã£o

- **Publisher:** `orders-service/services/ordersServices.js`
- **Consumer:** `notification-service/server.js`
- **Handler:** `notification-service/notificationHandler.js`
- **Client RabbitMQ:** `orders-service/shared/rabbitmq-client.js`
- **Documentation:** `EVENT_DRIVEN_ARCHITECTURE.md`

